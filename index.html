<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K. K. ENTERPRISES - Invoice Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Tinos&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Tinos', serif;
            background-color: #e5e7eb; /* gray-200 */
        }
        .invoice-box {
            font-family: 'Inter', sans-serif;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.15);
            font-size: 14px;
            line-height: 20px;
            color: #333;
        }
        [contenteditable]:focus {
            outline: 1px dashed #9ca3af;
            background-color: #fefce8;
        }
        
        /* Transparent highlight for editable areas - web view only */
        [contenteditable="true"] {
            background-color: rgba(254, 240, 138, 0.1);
            transition: background-color 0.2s;
        }
        [contenteditable="true"]:hover {
            background-color: rgba(254, 240, 138, 0.2);
        }
        [contenteditable="true"]:focus {
            background-color: #fefce8;
        }
        
        table, th, td {
            border: 1px solid #6b7280;
            border-collapse: collapse;
        }
        th, td {
            padding: 5px 8px;
            text-align: left;
        }
        .actions {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            padding: 20px 0;
            gap: 1rem;
        }
        
        /* PDF-specific styles */
        .pdf-container {
            width: 210mm;
            min-height: 297mm;
            margin: 0 auto;
            padding: 6mm;
            box-sizing: border-box;
            background: white;
            position: relative;
            font-size: 13px !important;
            line-height: 1.35 !important;
        }
        
        .pdf-container * {
            font-size: 13px !important;
            line-height: 1.35 !important;
        }
        
        .pdf-container h1 {
            font-size: 24px !important;
            margin-bottom: 4px !important;
        }
        
        /* CHANGED: Only increased table fonts */
        .pdf-container table {
            width: 100% !important;
            table-layout: fixed;
            font-size: 15px !important; /* INCREASED: from 12px to 15px */
        }
        
        .pdf-container th,
        .pdf-container td {
            padding: 3px 5px !important; /* INCREASED: from 2px 4px to 3px 5px */
            font-size: 15px !important; /* INCREASED: from 12px to 15px */
            line-height: 1.3 !important; /* INCREASED: from 1.2 to 1.3 */
        }
        
        .pdf-container .overflow-x-auto {
            overflow: visible !important;
        }
        
        .pdf-container .mb-2 { margin-bottom: 2px !important; }
        .pdf-container .mb-4 { margin-bottom: 3px !important; }
        .pdf-container .mt-4 { margin-top: 3px !important; }
        .pdf-container .py-2 { padding-top: 2px !important; padding-bottom: 2px !important; }
        .pdf-container .pt-2 { padding-top: 2px !important; }
        .pdf-container .pb-2 { padding-bottom: 2px !important; }
        
        /* Remove highlight backgrounds in PDF */
        .pdf-container [contenteditable="true"] {
            background-color: transparent !important;
        }
        
        /* Compact spacing for PDF */
        .pdf-container .totals-section {
            margin-top: 2px !important;
        }
        
        /* CHANGED: Only increased totals table font */
        .pdf-container .totals-section table {
            font-size: 14px !important; /* INCREASED: from 11px to 14px */
        }
        
        @media print {
            body * {
                visibility: hidden;
            }
            .invoice-box, .invoice-box * {
                visibility: visible;
            }
            .invoice-box {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                box-shadow: none;
                margin: 0;
                border: none;
            }
            .no-print {
                display: none !important;
            }
            /* Remove highlight backgrounds in print */
            [contenteditable="true"] {
                background-color: transparent !important;
            }
        }
        
        /* Better spacing for totals section */
        .totals-section {
            margin-top: 8px;
        }
        
        /* Reduce excessive spacing when there are fewer items */
        #invoice-body tr:last-child + tr {
            border-bottom: 2px solid #6b7280;
        }
        
        @media (max-width: 768px) {
            .invoice-box {
                font-size: 12px;
                line-height: 18px;
            }
            
            .mobile-stack {
                display: block !important;
            }
            
            .mobile-stack > div {
                width: 100% !important;
                margin-bottom: 10px;
                padding-right: 0 !important;
                border-right: none !important;
                border-bottom: 1px solid #6b7280;
                padding-bottom: 10px;
            }
            
            .mobile-stack > div:last-child {
                border-bottom: none;
                margin-bottom: 0;
                padding-bottom: 0;
            }
            
            .totals-section {
                margin-top: 6px;
            }
        }
    </style>
</head>
<body>
    <div class="actions no-print">
        <button onclick="addRow()" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
            Add Item Row
        </button>
        <button onclick="generatePDF()" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V4a2 2 0 00-2-2H6zm4 14a1 1 0 100-2 1 1 0 000 2zM6 5a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 000 2h6a1 1 0 100-2H7z" clip-rule="evenodd" />
            </svg>
            Save as PDF
        </button>
    </div>

    <div id="invoice" class="invoice-box max-w-4xl mx-auto p-4 md:p-6 bg-white my-4 md:my-8">
        <!-- Top Corner Info -->
        <div class="flex justify-between text-xs mb-2">
            <div>
                <p><strong>GSTIN:</strong> <span contenteditable="true">09CGWPS1563C1ZX</span></p>
            </div>

            <div>
                <p><strong>TAX INVOICE</strong> <span style="visibility: hidden;">.......................</span></p>
            </div>
            
            <div>
                <p><strong>M.:</strong> <span contenteditable="true">9565898222</span></p>
            </div>
        </div>
        
        <!-- Header -->
        <div class="text-center mb-2">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800" style="font-family: 'Tinos', serif;" contenteditable="true">K. K. ENTERPRISES</h1>
            <div class="text-sm md:text-base text-gray-600 mt-1 px-4" contenteditable="true">
                <p>Deals In : Operative Microscope, Micro Debrider, Endoscope, Surgical Camera,</p>
                <p>OPD Camera, Light Source,Endoscopy Head light & Instruments</p>
            </div>
        </div>
        
        <div class="text-center text-xs mb-4">
            <p contenteditable="true">D3/389, Sec -H, LDA Colony, Kanpur Road, Lucknow -226012, U.P. â€¢ E-mail: kkent3393@gmail.com</p>
        </div>
        
        <!-- Customer and Invoice Details -->
        <div class="border-t border-b border-gray-500 py-2">
            <div class="flex flex-col md:flex-row mobile-stack">
                <div class="w-full md:w-2/3 md:pr-2 md:border-r border-b md:border-b-0 border-gray-500 pb-2 md:pb-0 mb-2 md:mb-0">
                     <div class="flex items-start">
                        <strong class="mr-2 mt-1">Name:</strong>
                        <div contenteditable="true" class="flex-grow p-1"></div>
                    </div>
                    <div class="flex items-start">
                        <strong class="mr-2 mt-1">Add.:</strong>
                        <div contenteditable="true" class="flex-grow p-1"></div>
                    </div>
                     <div class="flex items-start">
                        <strong class="mr-2 mt-1">GSTIN:</strong>
                        <div contenteditable="true" class="flex-grow p-1"></div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-x-2">
                        <div><strong>PAN:</strong> <span contenteditable="true" class="p-1 inline-block w-2/3"></span></div>
                        <div><strong>State:</strong> <span contenteditable="true" class="p-1 inline-block w-2/3"></span></div>
                        <div><strong>State Code:</strong><span contenteditable="true" class="p-1 inline-block w-1/2"></span></div>
                    </div>
                </div>
                <div class="w-full md:w-1/3 md:pl-2">
                    <div class="flex"><strong>No.:</strong><span contenteditable="true" class="ml-2 flex-grow p-1"></span></div>
                    <div class="flex"><strong>Date:</strong><span id="date" contenteditable="true" class="ml-2 flex-grow p-1"></span></div>
                    <div class="flex"><strong>Order No.:</strong><span contenteditable="true" class="ml-2 flex-grow p-1"></span></div>
                    <div class="flex"><strong>E-Way Bill:</strong><span contenteditable="true" class="ml-2 flex-grow p-1"></span></div>
                </div>
            </div>
        </div>
        
        <!-- Items Table -->
        <div class="overflow-x-auto">
            <table class="w-full mt-4 text-sm min-w-[600px]">
                <thead>
                    <tr>
                        <th class="w-12">S. No.</th>
                        <th>DESCRIPTION</th>
                        <th class="w-24">HSN/SAC Code</th>
                        <th class="w-16">Qty.</th>
                        <th class="w-24">Rate</th>
                        <th class="w-32">Amount</th>
                        <th class="w-12 no-print"></th>
                    </tr>
                </thead>
                <tbody id="invoice-body">
                    <tr>
                        <td class="text-center" contenteditable="true">1</td>
                        <td contenteditable="true">Rad 40 Blade</td>
                        <td contenteditable="true"></td>
                        <td contenteditable="true" class="qty text-right">3</td>
                        <td contenteditable="true" class="rate text-right">6300.00</td>
                        <td class="amount text-right">18900.00</td>
                        <td class="text-center no-print"><button onclick="deleteRow(this)" class="text-red-500">âœ–</button></td>
                    </tr>
                     <tr>
                        <td class="text-center" contenteditable="true">2</td>
                        <td contenteditable="true">Rad 60 Blade</td>
                        <td contenteditable="true"></td>
                        <td contenteditable="true" class="qty text-right">1</td>
                        <td contenteditable="true" class="rate text-right">6500.00</td>
                        <td class="amount text-right">6500.00</td>
                        <td class="text-center no-print"><button onclick="deleteRow(this)" class="text-red-500">âœ–</button></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Totals -->
        <div class="flex justify-end totals-section">
             <div class="w-full sm:w-3/5 md:w-2/5">
                 <table class="w-full text-sm">
                     <tbody>
                         <tr>
                             <td class="font-bold border-r-0">TOTAL Amount Before Tax</td>
                             <td id="subtotal" class="text-right">25400.00</td>
                         </tr>
                         <tr>
                             <td>Freight Charge</td>
                             <td contenteditable="true" id="freight" class="text-right">0.00</td>
                         </tr>
                         <tr>
                             <td>Add CGST @ <span contenteditable="true" id="cgst-rate">9</span>%</td>
                             <td id="cgst" class="text-right">2286.00</td>
                         </tr>
                          <tr>
                             <td>Add SGST @ <span contenteditable="true" id="sgst-rate">9</span>%</td>
                             <td id="sgst" class="text-right">2286.00</td>
                         </tr>
                         <tr>
                             <td>Add IGST @ <span contenteditable="true" id="igst-rate">0</span>%</td>
                             <td id="igst" class="text-right">0.00</td>
                         </tr>
                         <tr>
                             <td>Round Off</td>
                             <td contenteditable="true" id="round-off" class="text-right">0.00</td>
                         </tr>
                         <tr class="bg-gray-200 font-bold">
                             <td>Grand Total</td>
                             <td id="grand-total" class="text-right">29972.00</td>
                         </tr>
                     </tbody>
                 </table>
             </div>
        </div>
        
        <!-- Footer -->
        <div class="border-t border-gray-500 mt-4 pt-2 text-sm">
             <p><strong>Total Invoice Amount in Words:</strong> <span id="amount-in-words">Twenty Nine Thousand Nine Hundred Seventy Two Rupees Only</span></p>
             <div class="flex flex-col sm:flex-row mt-4">
                 <div class="w-full sm:w-1/2 sm:pr-4 mb-4 sm:mb-0">
                     <p class="font-bold" contenteditable="true">K. K. ENTERPRISES</p>
                     <p><strong>A/c No.:</strong> <span contenteditable="true">215211100002643</span></p>
                     <p contenteditable="true">UNION BANK OF INDIA, RAEBAREILY ROAD, LUCKNOW, U.P.</p>
                     <p><strong>IFSC Code:</strong> <span contenteditable="true">UBIN0821527</span></p>
                     <div class="mt-4 text-xs">
                         <p class="font-bold">TERMS & CONDITIONS:</p>
                         <ol class="list-decimal list-inside">
                             <li contenteditable="true">E.&.O.E.</li>
                             <li contenteditable="true">Goods once sold will not be taken back</li>
                             <li contenteditable="true">All Disputes are subject to Lucknow Jurisdiction Only</li>
                         </ol>
                     </div>
                 </div>
                 <div class="w-full sm:w-1/2 sm:text-right flex flex-col items-start sm:items-end">
                     <div class="mt-12">
                         <p class="border-t border-gray-400 pt-1" contenteditable="true">Authorised Signatory</p>
                     </div>
                 </div>
             </div>
        </div>
    </div>

    <script>
        // Set current date
        const today = new Date();
        document.getElementById('date').textContent = `${today.getDate()}/${today.getMonth() + 1}/${today.getFullYear()}`;

        const invoiceBody = document.getElementById('invoice-body');
        
        function calculateTotals() {
            let subtotal = 0;
            const rows = invoiceBody.querySelectorAll('tr');
            rows.forEach(row => {
                const qty = parseFloat(row.querySelector('.qty').textContent.replace(/,/g, '')) || 0;
                const rate = parseFloat(row.querySelector('.rate').textContent.replace(/,/g, '')) || 0;
                const amount = qty * rate;
                row.querySelector('.amount').textContent = amount.toFixed(2);
                subtotal += amount;
            });

            const freight = parseFloat(document.getElementById('freight').textContent.replace(/,/g, '')) || 0;
            const cgstRate = parseFloat(document.getElementById('cgst-rate').textContent.replace(/,/g, '')) || 0;
            const sgstRate = parseFloat(document.getElementById('sgst-rate').textContent.replace(/,/g, '')) || 0;
            const igstRate = parseFloat(document.getElementById('igst-rate').textContent.replace(/,/g, '')) || 0;
            const roundOff = parseFloat(document.getElementById('round-off').textContent.replace(/,/g, '')) || 0;

            const subtotalWithFreight = subtotal + freight;
            
            const cgst = (subtotalWithFreight * cgstRate) / 100;
            const sgst = (subtotalWithFreight * sgstRate) / 100;
            const igst = (subtotalWithFreight * igstRate) / 100;

            const grandTotal = subtotalWithFreight + cgst + sgst + igst + roundOff;

            document.getElementById('subtotal').textContent = subtotal.toFixed(2);
            document.getElementById('cgst').textContent = cgst.toFixed(2);
            document.getElementById('sgst').textContent = sgst.toFixed(2);
            document.getElementById('igst').textContent = igst.toFixed(2);
            document.getElementById('grand-total').textContent = grandTotal.toFixed(2);
            document.getElementById('amount-in-words').textContent = numberToWords(Math.round(grandTotal)) + ' Rupees Only';
        }

        function addRow() {
            const rowCount = invoiceBody.rows.length;
            const newRow = invoiceBody.insertRow();
            newRow.innerHTML = `
                <td class="text-center" contenteditable="true">${rowCount + 1}</td>
                <td contenteditable="true"></td>
                <td contenteditable="true"></td>
                <td contenteditable="true" class="qty text-right">1</td>
                <td contenteditable="true" class="rate text-right">0.00</td>
                <td class="amount text-right">0.00</td>
                <td class="text-center no-print"><button onclick="deleteRow(this)" class="text-red-500">âœ–</button></td>
            `;
            addEventListeners(newRow);
        }

        function deleteRow(btn) {
            const row = btn.parentNode.parentNode;
            if (invoiceBody.rows.length > 1) {
                row.parentNode.removeChild(row);
                calculateTotals();
            } else {
                console.warn("Cannot delete the last row.");
            }
        }
        
        function addEventListeners(element) {
             element.querySelectorAll('[contenteditable="true"], .qty, .rate').forEach(el => {
                 el.addEventListener('input', calculateTotals);
             });
        }

        // Add event listeners to initial elements
        addEventListeners(document);
        calculateTotals(); // Initial calculation on page load

        function generatePDF() {
            const element = document.getElementById('invoice');
            
            // Create a clone of the invoice to manipulate without affecting the live view
            const clone = element.cloneNode(true);

            // Remove all elements with the 'no-print' class from the clone
            clone.querySelectorAll('.no-print').forEach(el => el.remove());

            // Create a temporary container with PDF-specific styling
            const tempContainer = document.createElement('div');
            tempContainer.className = 'pdf-container';
            tempContainer.innerHTML = clone.innerHTML;
            
            // Hide original element and add temp container to the body for rendering
            element.style.display = 'none';
            document.body.appendChild(tempContainer);
            
            // Calculate optimal scaling based on content height
            const contentHeight = tempContainer.scrollHeight;
            const maxHeight = 297; // A4 height in mm
            const availableHeight = maxHeight - 20; // Subtract margins
            
            // Adjust scale and canvas settings for better fitting
            const scale = Math.min(2, (availableHeight * 3.78) / contentHeight); // Convert mm to pixels
            
            const opt = {
                margin: [5, 5, 5, 5], // Reduced margins
                filename: `invoice_${document.getElementById('date').textContent.replace(/\//g, '-')}.pdf`,
                image: { type: 'jpeg', quality: 1.0 }, // CHANGED: Increased quality from 0.95 to 1.0
                html2canvas: { 
                    scale: 3, // CHANGED: Fixed high scale instead of dynamic for crisp text
                    useCORS: true,
                    width: 794, // A4 width in pixels at 96 DPI
                    height: Math.max(1123, contentHeight), // Dynamic height
                    scrollX: 0,
                    scrollY: 0,
                    letterRendering: true,
                    allowTaint: true,
                    dpi: 300 // CHANGED: Added high DPI for crisp text
                },
                jsPDF: { 
                    unit: 'mm', 
                    format: 'a4', 
                    orientation: 'portrait',
                    compress: false // CHANGED: Disabled compression to maintain quality
                },
                pagebreak: { 
                    mode: 'avoid-all',
                    avoid: ['tr', 'table']
                }
            };
            
            html2pdf().from(tempContainer).set(opt).save().then(() => {
                // Cleanup: remove temp container and restore original element
                document.body.removeChild(tempContainer);
                element.style.display = 'block';
            }).catch(error => {
                console.error('PDF generation failed:', error);
                // Cleanup on error
                if (document.body.contains(tempContainer)) {
                    document.body.removeChild(tempContainer);
                }
                element.style.display = 'block';
            });
        }

        // --- Number to Words Converter ---
        function numberToWords(num) {
            if (num === 0) return 'Zero';
            const a = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine', 'Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
            const b = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
            if ((num = num.toString()).length > 9) return 'overflow';
            const n = ('000000000' + num).substr(-9).match(/^(\d{2})(\d{2})(\d{2})(\d{1})(\d{2})$/);
            if (!n) return '';
            let str = '';
            str += (n[1] != 0) ? (a[Number(n[1])] || b[n[1][0]] + ' ' + a[n[1][1]]) + ' Crore ' : '';
            str += (n[2] != 0) ? (a[Number(n[2])] || b[n[2][0]] + ' ' + a[n[2][1]]) + ' Lakh ' : '';
            str += (n[3] != 0) ? (a[Number(n[3])] || b[n[3][0]] + ' ' + a[n[3][1]]) + ' Thousand ' : '';
            str += (n[4] != 0) ? (a[Number(n[4])] || b[n[4][0]] + ' ' + a[n[4][1]]) + ' Hundred ' : '';
            str += (n[5] != 0) ? ((str != '' && !str.endsWith(' ')) ? 'and ' : '') + (a[Number(n[5])] || b[n[5][0]] + ' ' + a[n[5][1]]) : '';
            return str.trim();
        }
    </script>
</body>
</html>
